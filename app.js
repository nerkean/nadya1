const express = require('express');
const path = require('path'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏
const TelegramBot = require('node-telegram-bot-api'); // <--- –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç

const app = express();
const PORT = process.env.PORT || 3000; // Render –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç —Å–≤–æ–π –ø–æ—Ä—Ç

// --- –ù–ê–°–¢–†–û–ô–ö–ò TELEGRAM –ë–û–¢–ê ---
// !!! –í–ê–ñ–ù–û: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—Å—Ç–∞–≤–ª—è–π —Ç–æ–∫–µ–Ω –∏ ID –ø—Ä—è–º–æ –≤ –∫–æ–¥!
// –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Environment Variables) –Ω–∞ —Ç–≤–æ–µ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ (Render).
const token = process.env.TELEGRAM_BOT_TOKEN; // –ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è —Ç–æ–∫–µ–Ω–∞
const chatId = process.env.TELEGRAM_CHAT_ID;   // –ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è ID —á–∞—Ç–∞

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–¥–∞–Ω—ã –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!token || !chatId) {
    console.warn('‚ö†Ô∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏/–∏–ª–∏ TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
    console.warn('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –£—Å—Ç–∞–Ω–æ–≤–∏ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–≤–æ–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞ (Render).');
}

let bot; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –±–æ—Ç–∞ –∑–¥–µ—Å—å

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏ chatId —Å—É—â–µ—Å—Ç–≤—É—é—Ç
if (token && chatId) {
    try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ (–æ—Ç–∫–ª—é—á–∞–µ–º polling, –Ω–∞–º –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫–∞)
        bot = new TelegramBot(token, { polling: false });
        console.log('‚úÖ Telegram –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram –±–æ—Ç–∞:', error.message);
        // –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
        bot = null; // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
    }
}
// --- –ö–æ–Ω–µ—Ü –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram ---


// Middleware –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ 'public'
app.use(express.static(path.join(__dirname, 'public')));

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ—Ç–¥–∞–µ–º index.html)
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è UptimeRobot
app.get('/ping', (req, res) => {
    res.status(200).send('OK'); // –ü—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
});

// --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ê–†–®–†–£–¢: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram ---
app.post('/log-visit', (req, res) => {
    const visitTime = new Date().toLocaleString('uk-UA', { timeZone: 'Europe/Kiev' });
    const logMessage = `‚û°Ô∏è  –ö—Ç–æ-—Ç–æ –∑–∞—à—ë–ª –Ω–∞ —Å–∞–π—Ç! –í—Ä–µ–º—è: ${visitTime}`;

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤ –ª–æ–≥–∏ Render)
    console.log(logMessage);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram, –µ—Å–ª–∏ –±–æ—Ç –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if (bot && token && chatId) { // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º token –∏ chatId –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        // –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ —É–≥–æ–¥–Ω–æ
        const telegramMessage = `üíñ –£—Ä–∞! –ö—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞—à–µ–ª –Ω–∞ —Ç–≤–æ–π –æ—Å–æ–±–µ–Ω–Ω—ã–π —Å–∞–π—Ç! ‚ú® (${visitTime})`;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º try-catch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
        try {
            bot.sendMessage(chatId, telegramMessage)
                .then(() => {
                    console.log('‚úâÔ∏è  –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
                })
                .catch((error) => {
                    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:', error.response ? error.response.body : error.message);
                    // –ü—Ä–∏–º–µ—Ä: error.code ETELEGRAM, error.response.body —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç API Telegram
                });
        } catch (error) {
            console.error('‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram:', error.message);
        }
    } else {
         console.log('‚ÑπÔ∏è  Telegram –±–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä (—á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–∞–π—Ç–µ –∑–Ω–∞–ª, —á—Ç–æ –≤—Å–µ –æ–∫)
    res.sendStatus(200); // –°—Ç–∞—Ç—É—Å 200 OK
});
// --- –ö–æ–Ω–µ—Ü –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ ---


// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
app.listen(PORT, () => {
    console.log(`üöÄ Server is running on http://localhost:${PORT}`);
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –∑–∞–¥–∞–Ω—ã
    if (!token || !chatId) {
         console.log("üí° –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN –∏ TELEGRAM_CHAT_ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞.");
    }
});